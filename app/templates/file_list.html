{% extends "base.html" %}

{% block title %}我的文件{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>我的文件</h1>

    <!-- 路径导航 -->
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('files.file_list') }}">我的文件</a>
            </li>
            {% for crumb in breadcrumbs %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('files.file_list', folder_id=crumb.id) }}">{{ crumb.name }}</a>
            </li>
            {% endfor %}
            {% if current_folder %}
            <li class="breadcrumb-item active" aria-current="page">{{ current_folder.name }}</li>
            {% endif %}
        </ol>
    </nav>

    <!-- 操作工具栏 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>操作</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- 上传文件表单 -->
                <div class="col-md-6 mb-3">
                    <form method="POST" action="{{ url_for('files.upload_file') }}" enctype="multipart/form-data">
                        <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}">
                        <div class="input-group">
                            <input class="form-control" type="file" id="file" name="file" required>
                            <button type="submit" class="btn btn-primary">上传文件</button>
                        </div>
                    </form>
                </div>

                <!-- 创建文件夹按钮和表单 -->
                <div class="col-md-6">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#createFolderModal">
                        创建文件夹
                    </button>

                    <!-- 创建文件夹模态框 -->
                    <div class="modal fade" id="createFolderModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">创建新文件夹</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('files.create_folder') }}">
                                    <input type="hidden" name="parent_id"
                                        value="{{ current_folder.id if current_folder else '' }}">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="folder_name" class="form-label">文件夹名称</label>
                                            <input type="text" class="form-control" id="folder_name" name="folder_name"
                                                required>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">取消</button>
                                        <button type="submit" class="btn btn-success">创建</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-text mt-2">
                支持的文件类型: {{ config.ALLOWED_EXTENSIONS|join(', ') }}<br>
                最大文件大小: {{ config.MAX_CONTENT_LENGTH/(1024*1024) }} MB
            </div>
        </div>
    </div>

    <!-- 内容列表（先显示文件夹，再显示文件） -->
    <div class="card">
        <div class="card-header">
            <h5>
                {% if current_folder %}
                {{ current_folder.name }} 中的内容
                {% else %}
                所有内容
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            {% if folders or files %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>类型</th>
                            <th>修改时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 显示文件夹 -->
                        {% for folder in folders %}
                        <tr>
                            <td>
                                <i class="bi bi-folder"></i>
                                <a href="{{ url_for('files.file_list', folder_id=folder.id) }}">{{ folder.name }}</a>
                            </td>
                            <td>文件夹</td>
                            <td>{{ folder.created_time.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal"
                                    data-bs-target="#renameFolderModal{{ folder.id }}">重命名</button>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteFolderModal{{ folder.id }}">删除</button>
                                <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                                    data-bs-target="#shareFolderModal{{ folder.id }}">
                                    分享
                                </button>

                                <!-- 分享文件夹模态框 -->
                                <div class="modal fade" id="shareFolderModal{{ folder.id }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">分享文件夹: {{ folder.name }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <form method="POST"
                                                action="{{ url_for('files.generate_folder_share', folder_id=folder.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="expires_in{{ folder.id }}"
                                                            class="form-label">设置过期时间</label>
                                                        <select class="form-select" id="expires_in{{ folder.id }}"
                                                            name="expires_in" required>
                                                            <option value="1">1小时</option>
                                                            <option value="24" selected>24小时</option>
                                                            <option value="168">7天</option>
                                                            <option value="720">30天</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">取消</button>
                                                    <button type="submit" class="btn btn-primary">生成分享链接</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- 文件夹重命名模态框 -->
                                <div class="modal fade" id="renameFolderModal{{ folder.id }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">重命名文件夹</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <form method="POST"
                                                action="{{ url_for('files.rename_folder', folder_id=folder.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="new_folder_name{{ folder.id }}"
                                                            class="form-label">新名称</label>
                                                        <input type="text" class="form-control"
                                                            id="new_folder_name{{ folder.id }}" name="new_name"
                                                            value="{{ folder.name }}" required>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">取消</button>
                                                    <button type="submit" class="btn btn-primary">确认</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- 文件夹删除确认模态框 -->
                                <div class="modal fade" id="deleteFolderModal{{ folder.id }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">确认删除</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                确定要删除文件夹 "{{ folder.name }}" 吗？此操作将删除该文件夹及其所有内容，且不可恢复。
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">取消</button>
                                                <form method="POST"
                                                    action="{{ url_for('files.delete_folder', folder_id=folder.id) }}">
                                                    <button type="submit" class="btn btn-danger">删除</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- 显示文件 -->
                        {% for file in files %}
                        <tr>
                            <td>
                                <i class="bi bi-file-earmark"></i>
                                {{ file.filename }}
                            </td>
                            <td>文件</td>
                            <td>{{ file.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <a href="{{ url_for('files.download_file', file_id=file.id) }}"
                                    class="btn btn-sm btn-success">下载</a>
                                <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal"
                                    data-bs-target="#renameFileModal{{ file.id }}">重命名</button>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#shareFileModal{{ file.id }}">分享</button>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteFileModal{{ file.id }}">删除</button>
                                

                                <!-- 分享文件模态框 -->
                                <div class="modal fade" id="shareFileModal{{ file.id }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">分享文件</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <form method="POST"
                                                action="{{ url_for('files.create_share', file_id=file.id) }}">
                                                <div class="modal-body">
                                                    <p>分享文件: {{ file.filename }}</p>
                                                    <div class="mb-3">
                                                        <label for="expires_in{{ file.id }}"
                                                            class="form-label">过期时间（小时）</label>
                                                        <select class="form-select" id="expires_in{{ file.id }}"
                                                            name="expires_in">
                                                            <option value="24">24小时</option>
                                                            <option value="72">3天</option>
                                                            <option value="168">7天</option>
                                                            <option value="720">30天</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">取消</button>
                                                    <button type="submit" class="btn btn-primary">创建分享链接</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <!-- 文件重命名模态框 -->
                                <div class="modal fade" id="renameFileModal{{ file.id }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">重命名文件</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <form method="POST"
                                                action="{{ url_for('files.rename_file', file_id=file.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="new_file_name{{ file.id }}"
                                                            class="form-label">新名称</label>
                                                        <input type="text" class="form-control"
                                                            id="new_file_name{{ file.id }}" name="new_name"
                                                            value="{{ file.filename }}" required>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">取消</button>
                                                    <button type="submit" class="btn btn-primary">确认</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- 文件删除确认模态框 -->
                                <div class="modal fade" id="deleteFileModal{{ file.id }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">确认删除</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                确定要删除文件 "{{ file.filename }}" 吗？此操作不可恢复。
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">取消</button>
                                                <form method="POST"
                                                    action="{{ url_for('files.delete_file', file_id=file.id) }}">
                                                    <button type="submit" class="btn btn-danger">删除</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if True %}
    <!-- 当前文件夹的分享管理 -->
    {% set folder_shares = current_folder.shares|selectattr('is_active')|list %}
    {% set file_shares = file_list %}
    {% if folder_shares or file_shares %}
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5>分享管理</h5>
        </div>
        <div class="card-body">
            <p>当前文件夹存在有效的分享链接：</p>
            <ul class="list-group">
                {% for share in folder_shares %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1">分享链接：<code>{{ url_for('files.access_shared', share_code=share.share_code, _external=True) }}</code></p>
                        <small class="text-muted">
                            有效期至：{{ (share.created_time + timedelta(hours=share.expires_in)).strftime('%Y-%m-%d %H:%M') }}
                        </small>
                    </div>
                    <form method="POST" action="{{ url_for('files.unshare_folder', share_id=share.id) }}" onsubmit="return confirm('确定要取消此分享吗？');">
                        <button type="submit" class="btn btn-sm btn-danger">取消分享</button>
                    </form>
                </li>
                {% endfor %}
                {% for share in file_shares %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1">分享链接：<code>{{ url_for('files.access_shared', share_code=share.share_code, _external=True) }}</code></p>
                        <small class="text-muted">
                            有效期至：{{ (share.created_time + timedelta(hours=share.expires_in)).strftime('%Y-%m-%d %H:%M') }}
                        </small>
                    </div>
                    <form method="POST" action="{{ url_for('files.cancel_share', share_id=share.id) }}" onsubmit="return confirm('确定要取消此分享吗？');">
                        <button type="submit" class="btn btn-sm btn-danger">取消分享</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
{% endif %}
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                此目录下没有文件或文件夹
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<!-- 引入Bootstrap图标 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
{% endblock %}